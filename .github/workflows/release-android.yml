name: Android Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    tags:
      - 'v*'
      - 'V*'

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android SDK
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-31" "platforms;android-34" "build-tools;34.0.0"

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare Android signing (optional)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' && env.ANDROID_KEYSTORE_PASSWORD != '' && env.ANDROID_KEY_ALIAS != '' && env.ANDROID_KEY_PASSWORD != '' }}
        run: |
          echo "Preparing signing files..."
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore.jks
          cat > android/key.properties <<'EOF'
          storeFile=keystore.jks
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF

      - name: Build Android APK (Debug)
        run: flutter build apk --debug

      - name: Ensure GitHub Release exists (for tag push)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Collect and rename artifacts
        run: |
          set -e
          mkdir -p dist
          REF_NAME="${GITHUB_REF_NAME:-${{ github.ref_name }}}"
          echo "Ref name: $REF_NAME"
          ls -la build/app/outputs/flutter-apk || true
          ls -la build/app/outputs/bundle/release || true

          if [ -f build/app/outputs/flutter-apk/app-debug.apk ]; then
            cp build/app/outputs/flutter-apk/app-debug.apk "dist/kelivo-${REF_NAME}-debug.apk"
          fi
          echo "Artifacts:"
          ls -la dist

      - name: Upload to GitHub Release (gh CLI)
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="${{ github.ref_name }}"
          echo "Ensuring release exists for $TAG ..."
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists."
          else
            gh release create "$TAG" -t "$TAG" -n "Auto-generated debug build for $TAG"
          fi
          echo "Uploading assets ..."
          gh release upload "$TAG" dist/* --clobber

