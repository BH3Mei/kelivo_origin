name: Android Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    tags:
      - 'v*'
      - 'V*'

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Prepare Android signing (optional)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' && env.ANDROID_KEYSTORE_PASSWORD != '' && env.ANDROID_KEY_ALIAS != '' && env.ANDROID_KEY_PASSWORD != '' }}
        run: |
          echo "Preparing signing files..."
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore.jks
          cat > android/key.properties <<'EOF'
          storeFile=keystore.jks
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF

      - name: Build Android APK (split per ABI)
        run: flutter build apk --release --split-per-abi

      - name: Build Android App Bundle (AAB)
        run: flutter build appbundle --release

      - name: Collect and rename artifacts
        run: |
          set -e
          mkdir -p dist
          REF_NAME="${GITHUB_REF_NAME:-${{ github.ref_name }}}"
          echo "Ref name: $REF_NAME"
          ls -la build/app/outputs/flutter-apk || true
          ls -la build/app/outputs/bundle/release || true

          if [ -f build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk "dist/kelivo-${REF_NAME}-arm64-v8a.apk"
          fi
          if [ -f build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk "dist/kelivo-${REF_NAME}-armeabi-v7a.apk"
          fi
          if [ -f build/app/outputs/flutter-apk/app-x86_64-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-x86_64-release.apk "dist/kelivo-${REF_NAME}-x86_64.apk"
          fi
          if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
            cp build/app/outputs/bundle/release/app-release.aab "dist/kelivo-${REF_NAME}.aab"
          fi
          echo "Artifacts:"
          ls -la dist

      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

